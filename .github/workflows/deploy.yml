name: Terraform Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual trigger for terraform apply
    inputs:
      terraform_dir:
        description: "Terraform working directory (e.g., QA, Prod, management)"
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: downloag terraform and awscli
        run: |
          sudo apt update
          wget https://releases.hashicorp.com/terraform/1.11.1/terraform_1.11.1_linux_amd64.zip
          unzip -o terraform_1.11.1_linux_amd64.zip
          terraform version
          sudo snap install aws-cli --classic
        
      - name: Set Terraform Directory
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger detected. Using input terraform_dir: ${{ inputs.terraform_dir }}"
            echo "TERRAFORM_DIR=${{ inputs.terraform_dir }}" >> $GITHUB_ENV
          else
            PREVIOUS_COMMIT=$(git rev-parse --verify ${{ github.event.before }} 2>/dev/null || echo "HEAD~1")
            CHANGED_DIRS=$(git diff --name-only $PREVIOUS_COMMIT ${{ github.sha }} | grep '^terraform/' | cut -d '/' -f2 | sort -u | uniq)
      
            if [ -z "$CHANGED_DIRS" ]; then
              echo "No Terraform directory changes detected. Skipping..."
              exit 1
            fi
            
            echo "Detected Terraform directory changes: $CHANGED_DIRS"
            echo "TERRAFORM_DIR=$CHANGED_DIRS" >> $GITHUB_ENV
          fi

      - name: Configure AWS-management Credentials 
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::902712839429:role/aws-actions-github-poc
          aws-region: us-east-1

      - name: Verify Terraform Directory Exists
        run: ls -R terraform/${{ env.TERRAFORM_DIR }}

      - name: Terraform Init
        working-directory: terraform/${{ env.TERRAFORM_DIR }}
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform/${{ env.TERRAFORM_DIR }}
        run: terraform plan

  terraform-apply:
    runs-on: terraform-runner
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Terraform Directory
        run: |
          echo "TERRAFORM_DIR=${{ inputs.terraform_dir }}" >> $GITHUB_ENV

      - name: Configure AWS-management Credentials 
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::902712839429:role/aws-actions-github-poc
          aws-region: us-east-1

      - name: Verify Terraform Directory Exists
        run: ls -R terraform/${{ env.TERRAFORM_DIR }}

      - name: Terraform Init
        working-directory: terraform/${{ env.TERRAFORM_DIR }}
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform/${{ env.TERRAFORM_DIR }}
        run: terraform apply --auto-approve
